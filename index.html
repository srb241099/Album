<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Drive Album</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#0b0c10">

  <style>
    :root{
      --bg:#0b0c10;
      --text:#f3f4f6;
      --muted:#a6adbb;
      --border:rgba(255,255,255,.10);
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);

      /* game accents */
      --accent:#7c3aed;      /* purple */
      --accent2:#06b6d4;     /* cyan */
      --accent3:#f59e0b;     /* amber */
      --pink:#ec4899;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--text);
      -webkit-tap-highlight-color: transparent;
      overflow:hidden;
    }
    .app{height:100%; display:flex; flex-direction:column}

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:20;
      padding: calc(10px + var(--safeTop)) 12px 10px;
      background: rgba(11,12,16,.92);
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .toprow{display:flex; align-items:center; gap:10px}
    .iconbtn{
      width:40px; height:40px; border-radius:14px;
      border:1px solid var(--border); background:rgba(255,255,255,.04);
      color:var(--text); display:flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none;
    }
    .iconbtn:active{transform:scale(.98)}
    .titlewrap{flex:1; min-width:0}
    .title{font-weight:900; font-size:16px; line-height:1.1}

    /* Search */
    .search{margin-top:10px}
    input{
      width:100%; padding:12px 12px; border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04); color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(255,255,255,.45)}

    /* Content */
    .content{
      flex:1; overflow:auto;
      padding: 12px 12px calc(12px + var(--safeBottom));
      -webkit-overflow-scrolling: touch;
    }
    .centerHint{
      text-align:center;
      color:var(--muted);
      padding:16px 6px;
      line-height:1.35;
      font-size:13px;
    }

    /* Folder list */
    .list{display:flex; flex-direction:column; gap:10px}
    .row{
      display:flex; align-items:center; gap:12px;
      padding:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      cursor:pointer;
    }
    .row:active{transform:scale(.99)}
    .badge{
      width:42px; height:42px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:18px;
      flex:0 0 auto;
    }
    .rowtext{flex:1; min-width:0}
    .rowtitle{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .rowmeta{font-size:12px; color:var(--muted); margin-top:2px}
    .chev{color:rgba(255,255,255,.55); font-size:18px}

    /* Grid */
    .grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;}
    @media (min-width: 420px){ .grid{grid-template-columns:repeat(4, 1fr)} }
    .tile{
      border-radius:14px; overflow:hidden; border:1px solid var(--border);
      background:rgba(255,255,255,.03); cursor:pointer;
      aspect-ratio: 1 / 1; position:relative;
    }
    .tile img{width:100%; height:100%; object-fit:cover; display:block; background:rgba(255,255,255,.06);}
    .tileshade{
      position:absolute; left:0; right:0; bottom:0;
      padding:6px 7px; font-size:11px; color:rgba(255,255,255,.92);
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.55));
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* Viewer */
    .viewer{
      position:fixed; inset:0; background:rgba(0,0,0,.94);
      z-index:50; display:none; flex-direction:column;
      touch-action: pan-y;
    }
    .viewer.open{display:flex}
    .viewerbar{
      padding: calc(10px + var(--safeTop)) 12px 10px;
      display:flex; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.38);
      backdrop-filter: blur(10px);
    }
    .viewername{
      flex:1; min-width:0; font-size:12px;
      color:rgba(255,255,255,.85);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pill{
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-size:13px; display:flex; align-items:center; gap:8px;
      cursor:pointer;
      justify-content:center;
    }
    .pill:active{transform:scale(.99)}

    .stage{
      flex:1;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      padding: 10px 10px calc(110px + var(--safeBottom));
    }
    .imgWrap{
      position:relative;
      width:100%;
      min-height:100%;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      overflow:visible;
      touch-action:none;
    }
    .imgLayer{
      width:min(96vw, 980px);
      height:auto;
      max-height:none;
      display:block;
      border-radius:16px;
      background:#111;
      border:1px solid rgba(255,255,255,.12);
      user-select:none;
      -webkit-user-drag:none;
      will-change: transform, opacity;
      transform-origin: center top;
      opacity:1;
      position:absolute;
      top:0;
      left:50%;
      transform: translate(-50%, 0);
      transition: transform 360ms cubic-bezier(.2,.8,.2,1), opacity 360ms cubic-bezier(.2,.8,.2,1);
    }
    #imgA{z-index:2}
    #imgB{z-index:1; opacity:0}

    .nav{
      position:fixed; left:12px; right:12px;
      bottom: calc(12px + var(--safeBottom));
      display:flex; gap:10px; z-index:55;
    }
    .nav button{
      flex:1; height:46px; border-radius:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text); font-weight:900; cursor:pointer;
    }
    .nav button:active{transform:scale(.99)}

    .zoomBar{
      position:fixed; right:12px;
      bottom: calc(70px + var(--safeBottom));
      display:flex; flex-direction:column; gap:10px;
      z-index:58;
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: calc(130px + var(--safeBottom));
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      display:none;
      z-index:60;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:block}

    /* PIN Lock Screen (Keypad) */
    .lock{
      position:fixed; inset:0;
      background:rgba(11,12,16,.98);
      display:flex; align-items:center; justify-content:center;
      z-index:9999;
      padding: calc(20px + var(--safeTop)) 16px calc(20px + var(--safeBottom));
    }
    .lockCard{
      width:min(420px, 100%);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      border-radius:20px;
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .lockTitle{
      font-weight:900;
      text-align:center;
      font-size:18px;
      margin:6px 0 12px;
    }
    .pinDots{display:flex; justify-content:center; gap:10px; margin:10px 0 14px;}
    .dot{
      width:12px; height:12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.06);
    }
    .dot.filled{background:rgba(255,255,255,.85)}
    .lockMsg{
      text-align:center;
      color:rgba(255,255,255,.7);
      font-size:12px;
      min-height:18px;
      margin-bottom:10px;
    }
    .keypad{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;}
    .key{
      height:54px; border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900; font-size:18px;
      cursor:pointer; user-select:none;
    }
    .key:active{transform:scale(.99)}
    .key.small{font-size:14px; font-weight:800}
    .lockRow{display:flex; gap:10px; margin-top:10px;}
    .lockRow .pill{flex:1; justify-content:center; height:46px;}

    /* Game page (colorful) */
    .game{
      position:fixed; inset:0;
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(124,58,237,.35), transparent 60%),
        radial-gradient(800px 500px at 90% 20%, rgba(6,182,212,.25), transparent 60%),
        radial-gradient(800px 500px at 30% 90%, rgba(236,72,153,.22), transparent 60%),
        rgba(11,12,16,.98);
      z-index:9000;
      display:none;
      flex-direction:column;
    }
    .game.open{display:flex}
    .gameBody{
      flex:1; overflow:auto; -webkit-overflow-scrolling: touch;
      padding: 12px 12px calc(12px + var(--safeBottom));
      display:flex; align-items:center; justify-content:center;
    }
    .gameCard{
      width:min(560px, 100%);
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      border-radius:24px;
      padding:14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 60px rgba(0,0,0,.35);
    }
    .modeRow{display:flex; gap:10px; margin-bottom:12px;}
    .modeBtn{
      flex:1; height:44px; border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center; gap:8px;
    }
    .modeBtn.active{
      border-color: rgba(255,255,255,.28);
      background: linear-gradient(135deg, rgba(124,58,237,.35), rgba(6,182,212,.25));
    }
    .modeBtn:active{transform:scale(.99)}
    .scoreRow{display:flex; gap:10px; margin-bottom:12px;}
    .scoreBox{
      flex:1;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      border-radius:18px;
      padding:10px 12px;
      text-align:center;
    }
    .scoreVal{font-weight:900; font-size:18px}
    .scoreLbl{font-size:12px; color:rgba(255,255,255,.72); margin-top:2px}

    /* ‚úÖ Board now has overlay win line */
    .board{
      position:relative;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .cell{
      height:98px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:44px;
      font-weight:900;
      cursor:pointer;
      user-select:none;
      position:relative;
      z-index:1;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.15);
    }
    .cell:active{transform:scale(.99)}
    .cell.x{ color: var(--accent3); text-shadow: 0 6px 30px rgba(245,158,11,.25); }
    .cell.o{ color: var(--accent2); text-shadow: 0 6px 30px rgba(6,182,212,.25); }

    .winline{
      position:absolute;
      left:0; top:0;
      width:0px; height:6px;
      background:#ff2d2d;
      border-radius:999px;
      box-shadow: 0 10px 30px rgba(255,45,45,.35);
      z-index:5;
      opacity:0;
      transform-origin:left center;
      transition: width 420ms cubic-bezier(.2,.8,.2,1), opacity 120ms ease;
      pointer-events:none;
    }
    .winline.show{opacity:1}

    .gameBtns{display:flex; gap:10px; margin-top:12px;}
    .gameBtns button{
      flex:1; height:46px; border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .gameBtns button.primary{
      background: linear-gradient(135deg, rgba(124,58,237,.55), rgba(236,72,153,.45));
      border-color: rgba(255,255,255,.22);
    }
    .gameBtns button:active{transform:scale(.99)}
    .hint{
      text-align:center;
      font-size:12px;
      color:rgba(255,255,255,.75);
      margin-top:10px;
      min-height:18px;
    }
  </style>
</head>

<body>

<!-- PIN lock -->
<div id="lockScreen" class="lock" aria-hidden="false">
  <div class="lockCard">
    <div class="lockTitle">üîí Private Album</div>

    <div class="pinDots" aria-label="PIN dots">
      <div class="dot" id="dot1"></div>
      <div class="dot" id="dot2"></div>
      <div class="dot" id="dot3"></div>
      <div class="dot" id="dot4"></div>
    </div>

    <div class="lockMsg" id="lockMsg">Enter 4-digit PIN</div>

    <div class="keypad">
      <button class="key" data-k="1" type="button">1</button>
      <button class="key" data-k="2" type="button">2</button>
      <button class="key" data-k="3" type="button">3</button>
      <button class="key" data-k="4" type="button">4</button>
      <button class="key" data-k="5" type="button">5</button>
      <button class="key" data-k="6" type="button">6</button>
      <button class="key" data-k="7" type="button">7</button>
      <button class="key" data-k="8" type="button">8</button>
      <button class="key" data-k="9" type="button">9</button>
      <button class="key small" data-k="clr" type="button">Clear</button>
      <button class="key" data-k="0" type="button">0</button>
      <button class="key small" data-k="del" type="button">‚å´</button>
    </div>

    <div class="lockRow">
      <button id="unlockBtn" class="pill" type="button">Unlock</button>
    </div>
  </div>
</div>

<div class="app">
  <div class="topbar">
    <div class="toprow">
      <div id="backBtn" class="iconbtn" style="display:none" aria-label="Back" type="button">‚Üê</div>
      <div class="titlewrap">
        <div id="pageTitle" class="title">Albums</div>
      </div>
    </div>
    <div class="search">
      <input id="search" placeholder="Search..." />
    </div>
  </div>

  <div class="content">
    <div id="homePage">
      <div id="status" class="centerHint">Loading‚Ä¶</div>
      <div id="folderList" class="list" style="display:none"></div>

      <div style="margin-top:14px;">
        <div class="row" id="gameRow" style="display:none;">
          <div class="badge">üéÆ</div>
          <div class="rowtext">
            <div class="rowtitle">Games</div>
            <div class="rowmeta">Tic Tac Toe</div>
          </div>
          <div class="chev">‚Ä∫</div>
        </div>
      </div>
    </div>

    <div id="thumbPage" style="display:none">
      <div id="thumbStatus" class="centerHint">Loading‚Ä¶</div>
      <div id="grid" class="grid" style="display:none"></div>
    </div>
  </div>
</div>

<!-- Viewer -->
<div id="viewer" class="viewer" aria-hidden="true">
  <div class="viewerbar">
    <div id="viewerClose" class="iconbtn" aria-label="Close" type="button">‚úï</div>
    <div id="viewerName" class="viewername"></div>
    <button id="downloadBtn" class="pill" type="button">‚¨á Download</button>
  </div>

  <div id="stage" class="stage">
    <div id="imgWrap" class="imgWrap">
      <img id="imgA" class="imgLayer" alt="photo" />
      <img id="imgB" class="imgLayer" alt="photo" />
    </div>
  </div>

  <div class="zoomBar">
    <div id="zoomIn" class="iconbtn" title="Zoom in" type="button">Ôºã</div>
    <div id="zoomOut" class="iconbtn" title="Zoom out" type="button">Ôºç</div>
    <div id="zoomReset" class="iconbtn" title="Reset" type="button">‚ü≤</div>
  </div>

  <div class="nav">
    <button id="prevBtn" type="button">‚Üê Prev</button>
    <button id="nextBtn" type="button">Next ‚Üí</button>
  </div>
</div>

<!-- Game Page -->
<div id="gamePage" class="game" aria-hidden="true">
  <div class="topbar">
    <div class="toprow">
      <div id="gameBack" class="iconbtn" aria-label="Back" type="button">‚Üê</div>
      <div class="titlewrap">
        <div class="title">Tic Tac Toe</div>
      </div>
    </div>
  </div>

  <div class="gameBody">
    <div class="gameCard">

      <div class="modeRow">
        <button class="modeBtn" id="modeAI" type="button">ü§ñ Play vs AI</button>
        <button class="modeBtn" id="mode2P" type="button">üë• Two Player</button>
      </div>

      <div class="scoreRow">
        <div class="scoreBox">
          <div class="scoreVal" id="winScore">0</div>
          <div class="scoreLbl" id="winLbl">Wins</div>
        </div>
        <div class="scoreBox">
          <div class="scoreVal" id="lossScore">0</div>
          <div class="scoreLbl" id="lossLbl">Losses</div>
        </div>
        <div class="scoreBox">
          <div class="scoreVal" id="drawScore">0</div>
          <div class="scoreLbl">Draws</div>
        </div>
      </div>

      <div class="scoreRow">
        <div class="scoreBox">
          <div class="scoreVal" id="bestWinStreak">0</div>
          <div class="scoreLbl">Best Win Streak</div>
        </div>
        <div class="scoreBox">
          <div class="scoreVal" id="curWinStreak">0</div>
          <div class="scoreLbl">Current Streak</div>
        </div>
      </div>

      <div class="board" id="board">
        <div id="winLine" class="winline"></div>

        <div class="cell" data-i="0"></div>
        <div class="cell" data-i="1"></div>
        <div class="cell" data-i="2"></div>
        <div class="cell" data-i="3"></div>
        <div class="cell" data-i="4"></div>
        <div class="cell" data-i="5"></div>
        <div class="cell" data-i="6"></div>
        <div class="cell" data-i="7"></div>
        <div class="cell" data-i="8"></div>
      </div>

      <div class="hint" id="gameHint"></div>

      <div class="gameBtns">
        <button id="newGameBtn" class="primary" type="button">New Game</button>
        <button id="resetScoreBtn" type="button">Reset Score</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================
   EDIT ONLY THESE 3 LINES
   ========================= */
const API_KEY = "AIzaSyCVe5FARO84ziutXGm_prf8eGMQCMvZQPI";
const ALBUM_FOLDER_ID = "1lzil08OmwD4N1TE4ta2ODpt8SNHb4Sal";
const ALBUM_PIN = "1234"; // 4 digits

/* =========================
   PIN LOCK (Keypad)
   ========================= */
let enteredPin = "";
const lockEl = document.getElementById("lockScreen");
const lockMsg = document.getElementById("lockMsg");
const dots = [
  document.getElementById("dot1"),
  document.getElementById("dot2"),
  document.getElementById("dot3"),
  document.getElementById("dot4"),
];

function renderDots(){ dots.forEach((d,i)=> d.classList.toggle("filled", i < enteredPin.length)); }
function setLockMsg(msg, isError=false){
  lockMsg.textContent = msg;
  lockMsg.style.color = isError ? "#f87171" : "rgba(255,255,255,.7)";
}
function clearPin(){ enteredPin=""; renderDots(); }
function hideLock(){ lockEl.style.display="none"; lockEl.setAttribute("aria-hidden","true"); }
function tryUnlock(){
  if(enteredPin.length !== 4){ setLockMsg("Enter 4 digits", true); return; }
  if(enteredPin === ALBUM_PIN){
    hideLock(); setLockMsg("Enter 4-digit PIN");
  }else{
    setLockMsg("Wrong PIN", true);
    lockEl.querySelector(".lockCard").animate(
      [{transform:"translateX(0)"},{transform:"translateX(-8px)"},{transform:"translateX(8px)"},{transform:"translateX(0)"}],
      {duration:220}
    );
    clearPin();
  }
}
document.querySelectorAll(".key").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const k = btn.dataset.k;
    if(k==="clr"){ clearPin(); setLockMsg("Enter 4-digit PIN"); return; }
    if(k==="del"){ enteredPin = enteredPin.slice(0,-1); renderDots(); setLockMsg("Enter 4-digit PIN"); return; }
    if(enteredPin.length < 4){
      enteredPin += k;
      renderDots();
      if(enteredPin.length === 4) tryUnlock();
    }
  });
});
document.getElementById("unlockBtn").addEventListener("click", tryUnlock);
window.addEventListener("keydown", (e)=>{
  if(lockEl.style.display === "none") return;
  if(e.key >= "0" && e.key <= "9"){
    if(enteredPin.length < 4){
      enteredPin += e.key;
      renderDots();
      if(enteredPin.length === 4) tryUnlock();
    }
  } else if(e.key === "Backspace"){
    enteredPin = enteredPin.slice(0, -1);
    renderDots();
  } else if(e.key === "Enter"){
    tryUnlock();
  } else if(e.key === "Escape"){
    clearPin(); setLockMsg("Enter 4-digit PIN");
  }
});

/* =========================
   Drive API
   ========================= */
const DRIVE_LIST = "https://www.googleapis.com/drive/v3/files";
const PAGE_SIZE = 200;

async function driveList({ q, fields, pageToken }) {
  const url = new URL(DRIVE_LIST);
  url.searchParams.set("key", API_KEY);
  url.searchParams.set("q", q);
  url.searchParams.set("fields", fields);
  url.searchParams.set("pageSize", String(PAGE_SIZE));
  url.searchParams.set("supportsAllDrives", "true");
  url.searchParams.set("includeItemsFromAllDrives", "true");
  if (pageToken) url.searchParams.set("pageToken", pageToken);

  const res = await fetch(url.toString());
  if (!res.ok) {
    const text = await res.text().catch(()=> "");
    throw new Error(`Drive API error (${res.status}): ${text || res.statusText}`);
  }
  return res.json();
}
function thumbUrl(fileId){ return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1200`; }
function fullUrl(fileId){ return `https://drive.google.com/uc?export=view&id=${fileId}`; }
function downloadUrl(fileId){ return `https://drive.google.com/uc?export=download&id=${fileId}`; }

/* UI elements */
const el = {
  backBtn: document.getElementById("backBtn"),
  pageTitle: document.getElementById("pageTitle"),
  search: document.getElementById("search"),

  homePage: document.getElementById("homePage"),
  status: document.getElementById("status"),
  folderList: document.getElementById("folderList"),
  gameRow: document.getElementById("gameRow"),

  thumbPage: document.getElementById("thumbPage"),
  thumbStatus: document.getElementById("thumbStatus"),
  grid: document.getElementById("grid"),

  viewer: document.getElementById("viewer"),
  viewerClose: document.getElementById("viewerClose"),
  viewerName: document.getElementById("viewerName"),
  downloadBtn: document.getElementById("downloadBtn"),
  prevBtn: document.getElementById("prevBtn"),
  nextBtn: document.getElementById("nextBtn"),

  stage: document.getElementById("stage"),
  imgWrap: document.getElementById("imgWrap"),
  imgA: document.getElementById("imgA"),
  imgB: document.getElementById("imgB"),

  zoomIn: document.getElementById("zoomIn"),
  zoomOut: document.getElementById("zoomOut"),
  zoomReset: document.getElementById("zoomReset"),

  toast: document.getElementById("toast"),

  gamePage: document.getElementById("gamePage"),
  gameBack: document.getElementById("gameBack"),
  board: document.getElementById("board"),
  winLine: document.getElementById("winLine"),
  gameHint: document.getElementById("gameHint"),
  newGameBtn: document.getElementById("newGameBtn"),
  resetScoreBtn: document.getElementById("resetScoreBtn"),

  winScore: document.getElementById("winScore"),
  lossScore: document.getElementById("lossScore"),
  drawScore: document.getElementById("drawScore"),
  bestWinStreak: document.getElementById("bestWinStreak"),
  curWinStreak: document.getElementById("curWinStreak"),

  modeAI: document.getElementById("modeAI"),
  mode2P: document.getElementById("mode2P"),
  winLbl: document.getElementById("winLbl"),
  lossLbl: document.getElementById("lossLbl"),
};

let folders = [];
let images = [];
let currentFolder = null;
let currentIndex = 0;
let page = "home";

/* Helpers */
function showToast(msg){
  el.toast.textContent = msg;
  el.toast.classList.add("show");
  setTimeout(()=> el.toast.classList.remove("show"), 1400);
}
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* =========================
   GAME: Tic Tac Toe (AI + Two Player)
   + Winner red line animation
   + High score (best win streak) stored locally
   ========================= */
const SCORE_KEY = "ttt_score_v4";
let score = { wins:0, losses:0, draws:0, bestStreak:0, curStreak:0 };

let ttt = Array(9).fill("");
let gameOver = false;
let mode = "ai"; // "ai" or "2p"
let turn = "X";
let waitingAI = false;

function loadScore(){
  try{
    const saved = JSON.parse(localStorage.getItem(SCORE_KEY) || "null");
    if(saved && typeof saved === "object") score = { ...score, ...saved };
  }catch{}
  renderScore();
}
function saveScore(){ localStorage.setItem(SCORE_KEY, JSON.stringify(score)); }
function renderScore(){
  el.winScore.textContent = score.wins;
  el.lossScore.textContent = score.losses;
  el.drawScore.textContent = score.draws;
  el.bestWinStreak.textContent = score.bestStreak;
  el.curWinStreak.textContent = score.curStreak;
}

function hideWinLine(){
  if(!el.winLine) return;
  el.winLine.classList.remove("show");
  el.winLine.style.width = "0px";
  el.winLine.style.transform = "translate(0px,0px) rotate(0deg)";
}

function checkWinnerWithLine(b){
  const L = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];
  for(const line of L){
    const [a,c,d] = line;
    if(b[a] && b[a]===b[c] && b[a]===b[d]) return { winner: b[a], line };
  }
  if(b.every(x=>x)) return { winner:"draw", line:null };
  return { winner:null, line:null };
}

function showWinLine(line){
  if(!el.winLine || !line) return;

  const boardRect = el.board.getBoundingClientRect();
  const cell0 = el.board.querySelector(`.cell[data-i="${line[0]}"]`);
  const cell2 = el.board.querySelector(`.cell[data-i="${line[2]}"]`);
  if(!cell0 || !cell2) return;

  const r0 = cell0.getBoundingClientRect();
  const r2 = cell2.getBoundingClientRect();

  const x1 = (r0.left + r0.right)/2 - boardRect.left;
  const y1 = (r0.top  + r0.bottom)/2 - boardRect.top;
  const x2 = (r2.left + r2.right)/2 - boardRect.left;
  const y2 = (r2.top  + r2.bottom)/2 - boardRect.top;

  const dx = x2 - x1, dy = y2 - y1;
  const len = Math.sqrt(dx*dx + dy*dy);
  const ang = Math.atan2(dy, dx) * 180/Math.PI;

  el.winLine.style.left = `${x1}px`;
  el.winLine.style.top  = `${y1 - 3}px`;
  el.winLine.style.transform = `rotate(${ang}deg)`;
  el.winLine.style.width = "0px";
  el.winLine.classList.add("show");

  requestAnimationFrame(()=>{ el.winLine.style.width = `${len}px`; });
}

function setMode(newMode){
  mode = newMode;
  el.modeAI.classList.toggle("active", mode==="ai");
  el.mode2P.classList.toggle("active", mode==="2p");

  if(mode === "ai"){
    el.winLbl.textContent = "Wins (You)";
    el.lossLbl.textContent = "Losses (AI)";
  }else{
    el.winLbl.textContent = "Wins (X)";
    el.lossLbl.textContent = "Wins (O)";
  }
  startTTT();
}

function openGame(){
  el.gamePage.classList.add("open");
  el.gamePage.setAttribute("aria-hidden","false");
  setMode(mode || "ai");
}
function closeGame(){
  el.gamePage.classList.remove("open");
  el.gamePage.setAttribute("aria-hidden","true");
}

function startTTT(){
  ttt = Array(9).fill("");
  gameOver = false;
  waitingAI = false;
  turn = "X";
  hideWinLine();
  el.gameHint.textContent = (mode==="ai") ? "Your turn (X)" : "Player X turn";
  [...el.board.querySelectorAll(".cell")].forEach(c=>{
    c.textContent="";
    c.classList.remove("x","o");
  });
}

/* AI: win > block > center > corners > random */
function findBestMove(board, mark){
  for(let i=0;i<9;i++){
    if(board[i] !== "") continue;
    const test = board.slice();
    test[i] = mark;
    if(checkWinnerWithLine(test).winner === mark) return i;
  }
  return -1;
}
function aiMove(){
  const b = ttt.slice();
  const winMove = findBestMove(b, "O");
  if(winMove !== -1) return winMove;
  const blockMove = findBestMove(b, "X");
  if(blockMove !== -1) return blockMove;
  if(b[4] === "") return 4;
  const corners = [0,2,6,8].filter(i=>b[i]==="");
  if(corners.length) return corners[Math.floor(Math.random()*corners.length)];
  const empties = b.map((v,i)=>v===""?i:-1).filter(i=>i!==-1);
  return empties.length ? empties[Math.floor(Math.random()*empties.length)] : -1;
}

function placeMark(i, mark){
  ttt[i] = mark;
  const cell = el.board.querySelector(`.cell[data-i="${i}"]`);
  if(cell){
    cell.textContent = mark;
    cell.classList.toggle("x", mark==="X");
    cell.classList.toggle("o", mark==="O");
  }
}

function endGame(result){
  gameOver = true;
  waitingAI = false;

  if(mode === "ai"){
    if(result === "X"){
      score.wins++;
      score.curStreak++;
      if(score.curStreak > score.bestStreak) score.bestStreak = score.curStreak;
      el.gameHint.textContent = "You Win üéâ";
      showToast("Win!");
    }else if(result === "O"){
      score.losses++;
      score.curStreak = 0;
      el.gameHint.textContent = "AI Wins";
      showToast("Loss");
    }else{
      score.draws++;
      score.curStreak = 0;
      el.gameHint.textContent = "Draw";
      showToast("Draw");
    }
  }else{
    if(result === "X"){
      score.wins++;
      el.gameHint.textContent = "Player X Wins üéâ";
      showToast("X Wins!");
    }else if(result === "O"){
      score.losses++;
      el.gameHint.textContent = "Player O Wins üéâ";
      showToast("O Wins!");
    }else{
      score.draws++;
      el.gameHint.textContent = "Draw";
      showToast("Draw");
    }
    score.curStreak = 0;
  }

  renderScore();
  saveScore();
}

el.board.addEventListener("click", (e)=>{
  const cell = e.target.closest(".cell");
  if(!cell) return;
  if(gameOver) return;
  if(waitingAI) return;

  const i = Number(cell.dataset.i);
  if(!Number.isFinite(i)) return;
  if(ttt[i] !== "") return;

  if(mode === "ai"){
    placeMark(i, "X");
    const w = checkWinnerWithLine(ttt);
    if(w.winner){
      if(w.winner !== "draw") showWinLine(w.line);
      endGame(w.winner === "draw" ? "draw" : w.winner);
      return;
    }

    waitingAI = true;
    el.gameHint.textContent = "AI thinking‚Ä¶";
    setTimeout(()=>{
      const m = aiMove();
      if(m !== -1 && ttt[m] === "") placeMark(m, "O");

      const w2 = checkWinnerWithLine(ttt);
      if(w2.winner){
        if(w2.winner !== "draw") showWinLine(w2.line);
        endGame(w2.winner === "draw" ? "draw" : w2.winner);
        return;
      }

      waitingAI = false;
      el.gameHint.textContent = "Your turn (X)";
    }, 260);

  }else{
    placeMark(i, turn);
    const w = checkWinnerWithLine(ttt);
    if(w.winner){
      if(w.winner !== "draw") showWinLine(w.line);
      endGame(w.winner === "draw" ? "draw" : w.winner);
      return;
    }
    turn = (turn === "X") ? "O" : "X";
    el.gameHint.textContent = `Player ${turn} turn`;
  }
});

el.newGameBtn.addEventListener("click", startTTT);
el.resetScoreBtn.addEventListener("click", ()=>{
  if(!confirm("Reset scores?")) return;
  score = { wins:0, losses:0, draws:0, bestStreak:0, curStreak:0 };
  renderScore(); saveScore(); startTTT();
});
el.gameBack.addEventListener("click", closeGame);
el.modeAI.addEventListener("click", ()=>setMode("ai"));
el.mode2P.addEventListener("click", ()=>setMode("2p"));

/* =========================
   Pages (Home / Thumbs)
   ========================= */
function setPage(newPage){
  page = newPage;
  if(page === "home"){
    el.backBtn.style.display = "none";
    el.homePage.style.display = "";
    el.thumbPage.style.display = "none";
    el.pageTitle.textContent = "Albums";
    el.search.value = "";
    renderFolderList();
  }else{
    el.backBtn.style.display = "";
    el.homePage.style.display = "none";
    el.thumbPage.style.display = "";
    el.pageTitle.textContent = currentFolder ? currentFolder.name : "Photos";
    el.search.value = "";
    renderThumbGrid(images);
  }
}

async function loadFolders(){
  el.status.textContent = "Loading‚Ä¶";
  el.folderList.style.display = "none";
  el.gameRow.style.display = "none";

  const q = [
    `'${ALBUM_FOLDER_ID}' in parents`,
    `mimeType = 'application/vnd.google-apps.folder'`,
    `trashed = false`
  ].join(" and ");

  const fields = "nextPageToken, files(id,name)";
  const all = [];
  let pageToken = null;

  while(true){
    const data = await driveList({ q, fields, pageToken });
    all.push(...(data.files || []));
    pageToken = data.nextPageToken;
    if(!pageToken) break;
  }

  folders = all.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  el.status.textContent = "";
  el.folderList.style.display = "";
  el.gameRow.style.display = "";
  renderFolderList();

  if(folders.length === 0) el.status.textContent = "No folders found.";
}

function renderFolderList(){
  const term = el.search.value.trim().toLowerCase();
  const list = term ? folders.filter(f => (f.name||"").toLowerCase().includes(term)) : folders;

  el.folderList.innerHTML = "";
  for(const f of list){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="badge">üìÅ</div>
      <div class="rowtext">
        <div class="rowtitle">${escapeHtml(f.name||"(no name)")}</div>
        <div class="rowmeta"></div>
      </div>
      <div class="chev">‚Ä∫</div>
    `;
    row.addEventListener("click", ()=>openFolder(f));
    el.folderList.appendChild(row);
  }
  if(list.length === 0) el.folderList.innerHTML = `<div class="centerHint">No results</div>`;
}

async function openFolder(folder){
  currentFolder = { id: folder.id, name: folder.name || "Photos" };
  setPage("thumbs");

  el.thumbStatus.textContent = "Loading‚Ä¶";
  el.grid.style.display = "none";
  el.grid.innerHTML = "";

  const q = [
    `'${currentFolder.id}' in parents`,
    `mimeType contains 'image/'`,
    `trashed = false`
  ].join(" and ");

  const fields = "nextPageToken, files(id,name)";
  const all = [];
  let pageToken = null;

  while(true){
    const data = await driveList({ q, fields, pageToken });
    all.push(...(data.files || []));
    pageToken = data.nextPageToken;
    if(!pageToken) break;
  }

  images = all.sort((a,b)=>(a.name||"").localeCompare(b.name||""))
    .map(f => ({
      id: f.id,
      name: f.name || "",
      thumb: thumbUrl(f.id),
      full: fullUrl(f.id),
      download: downloadUrl(f.id),
    }));

  if(images.length === 0){
    el.thumbStatus.textContent = "No images.";
    el.grid.style.display = "none";
    return;
  }

  el.thumbStatus.textContent = "";
  el.grid.style.display = "";
  renderThumbGrid(images);
}

function renderThumbGrid(list){
  const term = el.search.value.trim().toLowerCase();
  const viewList = term ? list.filter(x => (x.name||"").toLowerCase().includes(term)) : list;

  el.grid.innerHTML = "";
  for(const img of viewList){
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.innerHTML = `
      <img loading="lazy" src="${img.thumb}" alt="${escapeHtml(img.name)}">
      <div class="tileshade">${escapeHtml(img.name)}</div>
    `;
    tile.addEventListener("click", ()=>{
      const realIndex = images.findIndex(z => z.id === img.id);
      openViewer(realIndex >= 0 ? realIndex : 0);
    });
    el.grid.appendChild(tile);
  }
  if(viewList.length === 0) el.grid.innerHTML = `<div class="centerHint">No results</div>`;
}

el.backBtn.addEventListener("click", ()=>{
  currentFolder = null;
  images = [];
  el.grid.innerHTML = "";
  el.thumbStatus.textContent = "";
  setPage("home");
});
el.search.addEventListener("input", ()=>{
  if(page === "home") renderFolderList();
  else renderThumbGrid(images);
});
el.gameRow.addEventListener("click", openGame);

/* =========================
   Viewer: local download + zoom/pan + smooth swipe
   ========================= */
let scale = 1, tx = 0, ty = 0, activeImg = "A", animating = false;
let isPanning=false, pinch=false, startX=0,startY=0,startTx=0,startTy=0, startDist=0,startScale=1;
let lastMoveT=0, lastMoveX=0, lastMoveY=0, velX=0, velY=0, inertiaRAF=0;

function clampScale(s){ return Math.max(1, Math.min(s, 5)); }
function currentItem(){ return images[currentIndex]; }
function candidates(item){ return [item.full, item.download, item.thumb].filter(Boolean); }
function applyTransform(){
  const t = `translate(-50%, 0) translate(${tx}px, ${ty}px) scale(${scale})`;
  el.imgA.style.transform = t;
  el.imgB.style.transform = t;
}
function stopInertia(){ if(inertiaRAF) cancelAnimationFrame(inertiaRAF); inertiaRAF=0; }
function resetZoom(){ stopInertia(); scale=1; tx=0; ty=0; applyTransform(); el.stage.style.overflow="auto"; }
function lockScrollForPan(){ el.stage.style.overflow="hidden"; }
function activeImgEl(){ return (activeImg==="A") ? el.imgA : el.imgB; }
function clampPan(){
  if(scale<=1){ tx=0; ty=0; return; }
  const img = activeImgEl();
  const rect = img.getBoundingClientRect();
  const stageRect = el.stage.getBoundingClientRect();
  const extraX = Math.max(0, (rect.width - stageRect.width) / 2);
  const extraY = Math.max(0, (rect.height - stageRect.height) / 2);
  tx = Math.max(-extraX, Math.min(extraX, tx));
  ty = Math.max(-extraY, Math.min(extraY, ty));
}
function startInertia(vx, vy){
  stopInertia();
  const friction=0.92, minV=0.08;
  const step=()=>{
    vx*=friction; vy*=friction;
    tx+=vx; ty+=vy;
    clampPan(); applyTransform();
    if(Math.abs(vx)<minV && Math.abs(vy)<minV){ stopInertia(); return; }
    inertiaRAF=requestAnimationFrame(step);
  };
  inertiaRAF=requestAnimationFrame(step);
}
function setOpacity(showA){ el.imgA.style.opacity = showA ? "1":"0"; el.imgB.style.opacity = showA ? "0":"1"; }
function loadInto(imgEl, list, idx=0){
  return new Promise((resolve, reject)=>{
    if(idx>=list.length) return reject(new Error("blocked"));
    imgEl.onload = ()=>resolve(list[idx]);
    imgEl.onerror = ()=>loadInto(imgEl, list, idx+1).then(resolve).catch(reject);
    imgEl.src = list[idx];
  });
}
function openViewer(index){
  if(!images.length) return;
  currentIndex = Math.max(0, Math.min(index, images.length-1));
  el.viewer.classList.add("open");
  el.viewer.setAttribute("aria-hidden","false");
  activeImg="A"; setOpacity(true);
  el.stage.scrollTop=0;
  resetZoom();
  updateViewerInstant();
}
function closeViewer(){
  el.viewer.classList.remove("open");
  el.viewer.setAttribute("aria-hidden","true");
  el.imgA.src=""; el.imgB.src="";
  animating=false; stopInertia();
}
async function updateViewerInstant(){
  const item=currentItem();
  el.viewerName.textContent = `${currentIndex+1}/${images.length} ‚Ä¢ ${item.name||""}`;
  try{
    await loadInto(el.imgA, candidates(item));
    activeImg="A"; setOpacity(true);
    el.stage.scrollTop=0; resetZoom();
  }catch{ showToast("Blocked"); }
}
async function slideTo(newIndex, dir){
  if(animating) return;
  newIndex = Math.max(0, Math.min(newIndex, images.length-1));
  if(newIndex===currentIndex) return;
  if(scale>1){ showToast("Reset zoom"); return; }

  animating=true;
  const toItem=images[newIndex];
  const outEl=(activeImg==="A")?el.imgA:el.imgB;
  const inEl =(activeImg==="A")?el.imgB:el.imgA;

  try{ await loadInto(inEl, candidates(toItem)); }
  catch{ showToast("Blocked"); animating=false; return; }

  const off=34, inX=(dir>0)?off:-off, outX=(dir>0)?-off:off;

  inEl.style.transition="none"; outEl.style.transition="none";
  inEl.style.opacity="0"; outEl.style.opacity="1";
  inEl.style.transform=`translate(-50%, 0) translate(${inX}px, 0px) scale(1)`;
  outEl.style.transform=`translate(-50%, 0) translate(0px, 0px) scale(1)`;

  requestAnimationFrame(()=>{
    inEl.style.transition="transform 360ms cubic-bezier(.2,.8,.2,1), opacity 360ms cubic-bezier(.2,.8,.2,1)";
    outEl.style.transition="transform 360ms cubic-bezier(.2,.8,.2,1), opacity 360ms cubic-bezier(.2,.8,.2,1)";
    inEl.style.opacity="1"; outEl.style.opacity="0";
    inEl.style.transform=`translate(-50%, 0) translate(0px, 0px) scale(1)`;
    outEl.style.transform=`translate(-50%, 0) translate(${outX}px, 0px) scale(1)`;
  });

  setTimeout(()=>{
    currentIndex=newIndex;
    el.viewerName.textContent = `${currentIndex+1}/${images.length} ‚Ä¢ ${toItem.name||""}`;
    activeImg = (activeImg==="A") ? "B" : "A";
    setOpacity(activeImg==="A");
    resetZoom();
    animating=false;
  }, 380);
}
function nextPhoto(){ if(currentIndex>=images.length-1){ showToast("Last"); return; } slideTo(currentIndex+1,+1); }
function prevPhoto(){ if(currentIndex<=0){ showToast("First"); return; } slideTo(currentIndex-1,-1); }

el.nextBtn.addEventListener("click", nextPhoto);
el.prevBtn.addEventListener("click", prevPhoto);
el.viewerClose.addEventListener("click", closeViewer);

async function downloadCurrent(){
  const item=currentItem();
  const url=item.download || item.full || item.thumb;
  const filename=(item.name || `photo-${currentIndex+1}.jpg`).replace(/[^\w.\- ]+/g,"_");
  try{
    showToast("Downloading‚Ä¶");
    const res = await fetch(url, { mode:"cors" });
    if(!res.ok) throw new Error("blocked");
    const blob = await res.blob();
    const a=document.createElement("a");
    const objUrl=URL.createObjectURL(blob);
    a.href=objUrl; a.download=filename;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(objUrl);
    showToast("Saved");
  }catch{
    showToast("Opening‚Ä¶");
    window.location.href = url;
  }
}
el.downloadBtn.addEventListener("click", downloadCurrent);

el.zoomIn.addEventListener("click", ()=>{ scale=clampScale(scale+0.25); if(scale>1) lockScrollForPan(); clampPan(); applyTransform(); });
el.zoomOut.addEventListener("click", ()=>{
  scale=clampScale(scale-0.25);
  if(scale===1) resetZoom(); else { lockScrollForPan(); clampPan(); applyTransform(); }
});
el.zoomReset.addEventListener("click", resetZoom);

let lastTap=0;
el.imgWrap.addEventListener("click", ()=>{
  const now=Date.now();
  if(now-lastTap<300){
    if(scale===1){ scale=2; lockScrollForPan(); clampPan(); applyTransform(); }
    else resetZoom();
  }
  lastTap=now;
});

function dist(t1,t2){ return Math.hypot(t1.clientX-t2.clientX, t1.clientY-t2.clientY); }

el.imgWrap.addEventListener("touchstart",(e)=>{
  if(!el.viewer.classList.contains("open")) return;
  stopInertia(); velX=0; velY=0;

  if(e.touches.length===1){
    isPanning=true; pinch=false;
    startX=e.touches[0].clientX; startY=e.touches[0].clientY;
    startTx=tx; startTy=ty;
    lastMoveT=Date.now(); lastMoveX=startX; lastMoveY=startY;
  }else if(e.touches.length===2){
    pinch=true; isPanning=false;
    startDist=dist(e.touches[0],e.touches[1]);
    startScale=scale;
  }
},{passive:false});

el.imgWrap.addEventListener("touchmove",(e)=>{
  if(!el.viewer.classList.contains("open")) return;
  if(pinch || (isPanning && scale>1)) e.preventDefault();

  if(pinch && e.touches.length===2){
    const d=dist(e.touches[0],e.touches[1]);
    scale=clampScale(startScale*(d/startDist));
    if(scale>1) lockScrollForPan(); else el.stage.style.overflow="auto";
    clampPan(); applyTransform(); return;
  }
  if(isPanning && e.touches.length===1 && scale>1){
    const x=e.touches[0].clientX, y=e.touches[0].clientY;
    tx = startTx + (x-startX);
    ty = startTy + (y-startY);

    const now=Date.now(), dt=Math.max(1, now-lastMoveT);
    velX=(x-lastMoveX)/dt*16; velY=(y-lastMoveY)/dt*16;
    lastMoveT=now; lastMoveX=x; lastMoveY=y;

    clampPan(); applyTransform();
  }
},{passive:false});

el.imgWrap.addEventListener("touchend",()=>{
  if(scale>1) startInertia(velX, velY);
  isPanning=false; pinch=false;
},{passive:true});

let swipeStartX=0, swipeStartY=0, swiping=false;
el.viewer.addEventListener("touchstart",(e)=>{
  if(!el.viewer.classList.contains("open")) return;
  if(e.touches.length!==1) return;
  if(scale>1) return;
  const t=e.touches[0]; swipeStartX=t.clientX; swipeStartY=t.clientY; swiping=true;
},{passive:true});
el.viewer.addEventListener("touchend",(e)=>{
  if(!swiping) return;
  swiping=false;
  const t=e.changedTouches[0];
  const dx=t.clientX-swipeStartX, dy=t.clientY-swipeStartY;
  if(Math.abs(dx)>55 && Math.abs(dx)>Math.abs(dy)){
    if(dx<0) nextPhoto(); else prevPhoto();
  }
},{passive:true});

/* =========================
   Boot
   ========================= */
(async function init(){
  try{
    loadScore();
    setMode("ai"); // default game mode
    if(!API_KEY || API_KEY.includes("PASTE_")){
      el.status.textContent = "API_KEY missing";
      return;
    }
    await loadFolders();
    setPage("home");
  }catch(err){
    console.error(err);
    el.status.textContent = "Error: " + err.message;
  }
})();

/* PWA Service Worker register
   IMPORTANT: change /Album/ if your GitHub repo name is different */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("/Album/sw.js", { scope: "/Album/" })
      .catch(console.error);
  });
}
</script>
</body>
</html>
