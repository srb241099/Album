<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Drive Album (Mobile)</title>
  <style>
    :root{
      --bg:#0b0c10;
      --text:#f3f4f6;
      --muted:#a6adbb;
      --border:rgba(255,255,255,.10);
      --safeTop: env(safe-area-inset-top, 0px);
      --safeBottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg); color:var(--text);
      -webkit-tap-highlight-color: transparent;
      overflow:hidden;
    }
    .app{height:100%; display:flex; flex-direction:column}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:20;
      padding: calc(10px + var(--safeTop)) 12px 10px;
      background: rgba(11,12,16,.92);
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(10px);
    }
    .toprow{display:flex; align-items:center; gap:10px}
    .iconbtn{
      width:40px; height:40px; border-radius:14px;
      border:1px solid var(--border); background:rgba(255,255,255,.04);
      color:var(--text); display:flex; align-items:center; justify-content:center;
      cursor:pointer; user-select:none;
    }
    .iconbtn:active{transform:scale(.98)}
    .titlewrap{flex:1; min-width:0}
    .title{font-weight:900; font-size:16px; line-height:1.1}

    /* header ke niche text nahi chahiye => sub hidden */
    .sub{display:none}

    .search{margin-top:10px}
    input{
      width:100%; padding:12px 12px; border-radius:14px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04); color:var(--text);
      outline:none;
    }
    input::placeholder{color:rgba(255,255,255,.45)}

    .content{
      flex:1; overflow:auto;
      padding: 12px 12px calc(12px + var(--safeBottom));
      -webkit-overflow-scrolling: touch;
    }

    .centerHint{
      text-align:center;
      color:var(--muted);
      padding:16px 6px;
      line-height:1.35;
      font-size:13px;
    }

    /* Folder list */
    .list{display:flex; flex-direction:column; gap:10px}
    .row{
      display:flex; align-items:center; gap:12px;
      padding:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      border-radius:16px;
      cursor:pointer;
    }
    .row:active{transform:scale(.99)}
    .badge{
      width:42px; height:42px; border-radius:14px;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:18px;
      flex:0 0 auto;
    }
    .rowtext{flex:1; min-width:0}
    .rowtitle{font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .rowmeta{font-size:12px; color:var(--muted); margin-top:2px}
    .chev{color:rgba(255,255,255,.55); font-size:18px}

    /* Grid */
    .grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:8px;}
    @media (min-width: 420px){ .grid{grid-template-columns:repeat(4, 1fr)} }
    .tile{
      border-radius:14px; overflow:hidden; border:1px solid var(--border);
      background:rgba(255,255,255,.03); cursor:pointer;
      aspect-ratio: 1 / 1; position:relative;
    }
    .tile img{width:100%; height:100%; object-fit:cover; display:block; background:rgba(255,255,255,.06);}
    .tileshade{
      position:absolute; left:0; right:0; bottom:0;
      padding:6px 7px; font-size:11px; color:rgba(255,255,255,.92);
      background: linear-gradient(180deg, transparent, rgba(0,0,0,.55));
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    /* Viewer */
    .viewer{
      position:fixed; inset:0; background:rgba(0,0,0,.92);
      z-index:50; display:none; flex-direction:column;
      touch-action:none;
    }
    .viewer.open{display:flex}
    .viewerbar{
      padding: calc(10px + var(--safeTop)) 12px 10px;
      display:flex; align-items:center; gap:10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
    }
    .viewername{
      flex:1; min-width:0; font-size:12px;
      color:rgba(255,255,255,.85);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pill{
      padding:10px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--text); text-decoration:none;
      font-size:13px; display:flex; align-items:center; gap:8px;
      cursor:pointer;
    }
    .pill:active{transform:scale(.99)}

    .stage{
      flex:1; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      padding: 10px 10px calc(110px + var(--safeBottom));
      position:relative;
    }
    .imgWrap{
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      overflow:hidden;
      touch-action:none;
      position:relative;
    }

    /* Two-layer images for smooth swipe transition */
    .imgLayer{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      max-width:96vw;
      max-height:80vh;
      border-radius:16px;
      background:#111;
      border:1px solid rgba(255,255,255,.12);
      user-select:none;
      -webkit-user-drag:none;
      will-change: transform, opacity;
      opacity:1;
    }
    #imgA{z-index:2}
    #imgB{z-index:1; opacity:0}

    .nav{
      position:fixed; left:12px; right:12px;
      bottom: calc(12px + var(--safeBottom));
      display:flex; gap:10px; z-index:55;
    }
    .nav button{
      flex:1; height:46px; border-radius:16px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text); font-weight:900; cursor:pointer;
    }
    .nav button:active{transform:scale(.99)}

    .zoomBar{
      position:fixed; right:12px;
      bottom: calc(70px + var(--safeBottom));
      display:flex; flex-direction:column; gap:10px;
      z-index:58;
    }

    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      bottom: calc(130px + var(--safeBottom));
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      display:none;
      z-index:60;
      backdrop-filter: blur(10px);
    }
    .toast.show{display:block}
  </style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="toprow">
      <div id="backBtn" class="iconbtn" style="display:none" aria-label="Back">‚Üê</div>
      <div class="titlewrap">
        <div id="pageTitle" class="title">Albums</div>
        <div id="pageSub" class="sub"></div>
      </div>
    </div>
    <div class="search">
      <input id="search" placeholder="Search..." />
    </div>
  </div>

  <div class="content">
    <div id="homePage">
      <div id="status" class="centerHint">Loading folders‚Ä¶</div>
      <div id="folderList" class="list" style="display:none"></div>
    </div>

    <div id="thumbPage" style="display:none">
      <div id="thumbStatus" class="centerHint">Loading images‚Ä¶</div>
      <div id="grid" class="grid" style="display:none"></div>
    </div>
  </div>
</div>

<!-- Viewer -->
<div id="viewer" class="viewer" aria-hidden="true">
  <div class="viewerbar">
    <div id="viewerClose" class="iconbtn" aria-label="Close">‚úï</div>
    <div id="viewerName" class="viewername"></div>
    <button id="downloadBtn" class="pill" type="button">‚¨á Download</button>
  </div>

  <div class="stage">
    <div id="imgWrap" class="imgWrap">
      <img id="imgA" class="imgLayer" alt="photo" />
      <img id="imgB" class="imgLayer" alt="photo" />
    </div>
  </div>

  <div class="zoomBar">
    <div id="zoomIn" class="iconbtn" title="Zoom in">Ôºã</div>
    <div id="zoomOut" class="iconbtn" title="Zoom out">Ôºç</div>
    <div id="zoomReset" class="iconbtn" title="Reset">‚ü≤</div>
  </div>

  <div class="nav">
    <button id="prevBtn">‚Üê Prev</button>
    <button id="nextBtn">Next ‚Üí</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================
   EDIT ONLY THIS API KEY
   ========================= */
const API_KEY = "AIzaSyCVe5FARO84ziutXGm_prf8eGMQCMvZQPI";
const ALBUM_FOLDER_ID = "1lzil08OmwD4N1TE4ta2ODpt8SNHb4Sal";

/* Drive API list */
const DRIVE_LIST = "https://www.googleapis.com/drive/v3/files";
const PAGE_SIZE = 200;

async function driveList({ q, fields, pageToken }) {
  const url = new URL(DRIVE_LIST);
  url.searchParams.set("key", API_KEY);
  url.searchParams.set("q", q);
  url.searchParams.set("fields", fields);
  url.searchParams.set("pageSize", String(PAGE_SIZE));
  url.searchParams.set("supportsAllDrives", "true");
  url.searchParams.set("includeItemsFromAllDrives", "true");
  if (pageToken) url.searchParams.set("pageToken", pageToken);

  const res = await fetch(url.toString());
  if (!res.ok) {
    const text = await res.text().catch(()=> "");
    throw new Error(`Drive API error (${res.status}): ${text || res.statusText}`);
  }
  return res.json();
}

function thumbUrl(fileId){ return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1200`; }
function fullUrl(fileId){ return `https://drive.google.com/uc?export=view&id=${fileId}`; }
function downloadUrl(fileId){ return `https://drive.google.com/uc?export=download&id=${fileId}`; }

/* UI */
const el = {
  backBtn: document.getElementById("backBtn"),
  pageTitle: document.getElementById("pageTitle"),
  search: document.getElementById("search"),

  homePage: document.getElementById("homePage"),
  status: document.getElementById("status"),
  folderList: document.getElementById("folderList"),

  thumbPage: document.getElementById("thumbPage"),
  thumbStatus: document.getElementById("thumbStatus"),
  grid: document.getElementById("grid"),

  viewer: document.getElementById("viewer"),
  viewerClose: document.getElementById("viewerClose"),
  viewerName: document.getElementById("viewerName"),
  downloadBtn: document.getElementById("downloadBtn"),
  prevBtn: document.getElementById("prevBtn"),
  nextBtn: document.getElementById("nextBtn"),

  imgWrap: document.getElementById("imgWrap"),
  imgA: document.getElementById("imgA"),
  imgB: document.getElementById("imgB"),
  zoomIn: document.getElementById("zoomIn"),
  zoomOut: document.getElementById("zoomOut"),
  zoomReset: document.getElementById("zoomReset"),

  toast: document.getElementById("toast"),
};

let folders = [];
let images = [];
let currentFolder = null;
let currentIndex = 0;
let page = "home";

/* Toast */
function showToast(msg){
  el.toast.textContent = msg;
  el.toast.classList.add("show");
  setTimeout(()=> el.toast.classList.remove("show"), 1400);
}

/* Pages */
function setPage(newPage){
  page = newPage;
  if(page === "home"){
    el.backBtn.style.display = "none";
    el.homePage.style.display = "";
    el.thumbPage.style.display = "none";
    el.pageTitle.textContent = "Albums";
    el.search.value = "";
    renderFolderList();
  }else{
    el.backBtn.style.display = "";
    el.homePage.style.display = "none";
    el.thumbPage.style.display = "";
    el.pageTitle.textContent = currentFolder ? currentFolder.name : "Photos";
    el.search.value = "";
    renderThumbGrid(images);
  }
}

/* Load folders */
async function loadFolders(){
  el.status.textContent = "Loading folders‚Ä¶";
  el.folderList.style.display = "none";

  const q = [
    `'${ALBUM_FOLDER_ID}' in parents`,
    `mimeType = 'application/vnd.google-apps.folder'`,
    `trashed = false`
  ].join(" and ");

  const fields = "nextPageToken, files(id,name)";
  const all = [];
  let pageToken = null;

  while(true){
    const data = await driveList({ q, fields, pageToken });
    all.push(...(data.files || []));
    pageToken = data.nextPageToken;
    if(!pageToken) break;
  }

  folders = all.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
  if(folders.length === 0){
    el.status.textContent = "No folders found inside Album.";
    return;
  }

  el.status.textContent = "";
  el.folderList.style.display = "";
  renderFolderList();
}

function renderFolderList(){
  const term = el.search.value.trim().toLowerCase();
  const list = term ? folders.filter(f => (f.name||"").toLowerCase().includes(term)) : folders;

  el.folderList.innerHTML = "";
  for(const f of list){
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div class="badge">üìÅ</div>
      <div class="rowtext">
        <div class="rowtitle">${escapeHtml(f.name||"(no name)")}</div>
        <div class="rowmeta">Tap to open</div>
      </div>
      <div class="chev">‚Ä∫</div>
    `;
    row.addEventListener("click", ()=>openFolder(f));
    el.folderList.appendChild(row);
  }
  if(list.length === 0){
    el.folderList.innerHTML = `<div class="centerHint">No matching folder.</div>`;
  }
}

/* Load images */
async function openFolder(folder){
  currentFolder = { id: folder.id, name: folder.name || "Photos" };
  setPage("thumbs");

  el.thumbStatus.textContent = "Loading images‚Ä¶";
  el.grid.style.display = "none";
  el.grid.innerHTML = "";

  const q = [
    `'${currentFolder.id}' in parents`,
    `mimeType contains 'image/'`,
    `trashed = false`
  ].join(" and ");

  const fields = "nextPageToken, files(id,name)";
  const all = [];
  let pageToken = null;

  while(true){
    const data = await driveList({ q, fields, pageToken });
    all.push(...(data.files || []));
    pageToken = data.nextPageToken;
    if(!pageToken) break;
  }

  images = all.sort((a,b)=>(a.name||"").localeCompare(b.name||""))
    .map(f => ({
      id: f.id,
      name: f.name || "",
      thumb: thumbUrl(f.id),
      full: fullUrl(f.id),
      download: downloadUrl(f.id),
    }));

  if(images.length === 0){
    el.thumbStatus.textContent = "No images in this folder.";
    el.grid.style.display = "none";
    return;
  }

  el.thumbStatus.textContent = "";
  el.grid.style.display = "";
  renderThumbGrid(images);
}

function renderThumbGrid(list){
  const term = el.search.value.trim().toLowerCase();
  const viewList = term ? list.filter(x => (x.name||"").toLowerCase().includes(term)) : list;

  el.grid.innerHTML = "";
  for(const img of viewList){
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.innerHTML = `
      <img loading="lazy" src="${img.thumb}" alt="${escapeHtml(img.name)}">
      <div class="tileshade">${escapeHtml(img.name)}</div>
    `;
    tile.addEventListener("click", ()=>{
      const realIndex = images.findIndex(z => z.id === img.id);
      openViewer(realIndex >= 0 ? realIndex : 0);
    });
    el.grid.appendChild(tile);
  }
  if(viewList.length === 0){
    el.grid.innerHTML = `<div class="centerHint">No matching photo.</div>`;
  }
}

/* =========================
   Viewer + Zoom/Pan + Smooth swipe transition
   ========================= */
let scale = 1;
let tx = 0, ty = 0;

let activeImg = "A"; // which layer is currently visible

function clampScale(s){ return Math.max(1, Math.min(s, 5)); } // up to 5x

function applyTransform(){
  // Apply transform to BOTH layers, so transition doesn't jump
  const t = `translate(${tx}px, ${ty}px) scale(${scale})`;
  el.imgA.style.transform = `translate(-50%,-50%) ${t}`;
  el.imgB.style.transform = `translate(-50%,-50%) ${t}`;
}

function resetZoom(){
  scale = 1; tx = 0; ty = 0;
  applyTransform();
}

function currentItem(){ return images[currentIndex]; }

function getCandidates(item){
  return [item.full, item.download, item.thumb].filter(Boolean);
}

function setLayerOpacity(showA){
  el.imgA.style.opacity = showA ? "1" : "0";
  el.imgB.style.opacity = showA ? "0" : "1";
}

function setLayerTransition(on){
  const v = on ? "transform 260ms ease, opacity 260ms ease" : "none";
  el.imgA.style.transition = v;
  el.imgB.style.transition = v;
}

/* Load image into a layer with fallback */
function loadInto(imgEl, candidates, idx=0){
  return new Promise((resolve, reject) => {
    if(idx >= candidates.length) return reject(new Error("blocked"));
    imgEl.onload = () => resolve(candidates[idx]);
    imgEl.onerror = () => loadInto(imgEl, candidates, idx+1).then(resolve).catch(reject);
    imgEl.src = candidates[idx];
  });
}

function openViewer(index){
  if(!images.length) return;
  currentIndex = Math.max(0, Math.min(index, images.length-1));

  el.viewer.classList.add("open");
  el.viewer.setAttribute("aria-hidden","false");

  // initial
  activeImg = "A";
  setLayerTransition(false);
  setLayerOpacity(true);
  resetZoom();

  updateViewerInstant();
}

function closeViewer(){
  el.viewer.classList.remove("open");
  el.viewer.setAttribute("aria-hidden","true");
  el.imgA.src = "";
  el.imgB.src = "";
}

async function updateViewerInstant(){
  const item = currentItem();
  el.viewerName.textContent = `${currentIndex+1}/${images.length} ‚Ä¢ ${item.name || ""}`;

  const candidates = getCandidates(item);
  try{
    await loadInto(el.imgA, candidates);
    activeImg = "A";
    setLayerOpacity(true);
  }catch{
    showToast("Image blocked by sharing");
  }
}

/* Smooth slide transition on next/prev */
async function slideTo(newIndex, dir /* -1 left(prev) / +1 right(next) */){
  if(!images.length) return;
  newIndex = Math.max(0, Math.min(newIndex, images.length-1));
  if(newIndex === currentIndex) return;

  const fromItem = images[currentIndex];
  const toItem = images[newIndex];

  // When zoomed, keep move capability; but for slide we reset zoom for clean UX
  resetZoom();

  // Determine outgoing & incoming layers
  const outEl = (activeImg === "A") ? el.imgA : el.imgB;
  const inEl  = (activeImg === "A") ? el.imgB : el.imgA;

  // Load next image into incoming layer (with fallbacks)
  inEl.style.transition = "none";
  outEl.style.transition = "none";

  const candidates = getCandidates(toItem);
  try{
    await loadInto(inEl, candidates);
  }catch{
    showToast("Image blocked by sharing");
    return;
  }

  // Set base transforms for slide
  const offset = 40; // px
  // outgoing goes opposite direction
  const outX = (dir > 0) ? -offset : offset;
  const inX  = (dir > 0) ? offset : -offset;

  // start state
  outEl.style.opacity = "1";
  inEl.style.opacity = "0";
  // Both already have translate(-50%,-50%) + current pan/zoom transform in applyTransform()
  // We add an extra translateX via CSS variable trick using inline transform:
  // easiest: temporarily adjust tx without losing pan => use extra translate in style
  outEl.style.transform = `translate(-50%,-50%) translate(${tx + 0}px, ${ty + 0}px) scale(${scale})`;
  inEl.style.transform  = `translate(-50%,-50%) translate(${tx + inX}px, ${ty + 0}px) scale(${scale})`;

  // animate
  setTimeout(() => {
    outEl.style.transition = "transform 260ms ease, opacity 260ms ease";
    inEl.style.transition  = "transform 260ms ease, opacity 260ms ease";

    outEl.style.opacity = "0";
    inEl.style.opacity  = "1";

    outEl.style.transform = `translate(-50%,-50%) translate(${tx + outX}px, ${ty + 0}px) scale(${scale})`;
    inEl.style.transform  = `translate(-50%,-50%) translate(${tx + 0}px, ${ty + 0}px) scale(${scale})`;
  }, 0);

  // finish
  setTimeout(() => {
    currentIndex = newIndex;
    el.viewerName.textContent = `${currentIndex+1}/${images.length} ‚Ä¢ ${toItem.name || ""}`;

    // swap active layer
    activeImg = (activeImg === "A") ? "B" : "A";

    // normalize transforms back to pan/zoom system
    setLayerTransition(false);
    applyTransform();
    // show only active layer
    setLayerOpacity(activeImg === "A");
  }, 280);
}

/* Next/Prev */
function nextPhoto(){
  if(currentIndex >= images.length-1){ showToast("Last photo"); return; }
  slideTo(currentIndex + 1, +1);
}
function prevPhoto(){
  if(currentIndex <= 0){ showToast("First photo"); return; }
  slideTo(currentIndex - 1, -1);
}

el.nextBtn.addEventListener("click", nextPhoto);
el.prevBtn.addEventListener("click", prevPhoto);
el.viewerClose.addEventListener("click", closeViewer);

/* Back */
el.backBtn.addEventListener("click", ()=>{
  currentFolder = null;
  images = [];
  el.grid.innerHTML = "";
  el.thumbStatus.textContent = "";
  setPage("home");
});

/* Search */
el.search.addEventListener("input", ()=>{
  if(page === "home") renderFolderList();
  else renderThumbGrid(images);
});

/* Download local: fetch blob and save */
async function downloadCurrent(){
  const item = currentItem();
  const url = item.download || item.full || item.thumb;
  const filename = (item.name || `photo-${currentIndex+1}.jpg`).replace(/[^\w.\- ]+/g,"_");

  try{
    showToast("Downloading‚Ä¶");
    const res = await fetch(url, { mode: "cors" });
    if(!res.ok) throw new Error("blocked");
    const blob = await res.blob();
    const a = document.createElement("a");
    const objUrl = URL.createObjectURL(blob);
    a.href = objUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(objUrl);
    showToast("Saved");
  }catch{
    showToast("Download blocked");
  }
}
el.downloadBtn.addEventListener("click", downloadCurrent);

/* Zoom buttons */
el.zoomIn.addEventListener("click", ()=>{ scale = clampScale(scale + 0.25); applyTransform(); });
el.zoomOut.addEventListener("click", ()=>{
  scale = clampScale(scale - 0.25);
  if(scale === 1){ tx = 0; ty = 0; }
  applyTransform();
});
el.zoomReset.addEventListener("click", resetZoom);

/* Double tap zoom */
let lastTap = 0;
el.imgWrap.addEventListener("click", ()=>{
  const now = Date.now();
  if(now - lastTap < 300){
    scale = (scale === 1) ? 2 : 1;
    if(scale === 1){ tx = 0; ty = 0; }
    applyTransform();
  }
  lastTap = now;
});

/* Pan + pinch zoom (touch) ‚Äî move after zoom ‚úÖ */
let isPanning = false;
let startX = 0, startY = 0;
let startTx = 0, startTy = 0;

let pinch = false;
let startDist = 0;
let startScale = 1;

function dist(t1, t2){
  const dx = t1.clientX - t2.clientX;
  const dy = t1.clientY - t2.clientY;
  return Math.hypot(dx, dy);
}

el.imgWrap.addEventListener("touchstart", (e)=>{
  if(!el.viewer.classList.contains("open")) return;

  if(e.touches.length === 1){
    isPanning = true; pinch = false;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    startTx = tx; startTy = ty;
  } else if(e.touches.length === 2){
    pinch = true; isPanning = false;
    startDist = dist(e.touches[0], e.touches[1]);
    startScale = scale;
  }
}, {passive:false});

el.imgWrap.addEventListener("touchmove", (e)=>{
  if(!el.viewer.classList.contains("open")) return;
  e.preventDefault();

  if(pinch && e.touches.length === 2){
    const d = dist(e.touches[0], e.touches[1]);
    const factor = d / startDist;
    scale = clampScale(startScale * factor);
    applyTransform();
    return;
  }

  // move/pan when zoomed
  if(isPanning && e.touches.length === 1 && scale > 1){
    const x = e.touches[0].clientX;
    const y = e.touches[0].clientY;
    tx = startTx + (x - startX);
    ty = startTy + (y - startY);
    applyTransform();
  }
}, {passive:false});

el.imgWrap.addEventListener("touchend", ()=>{
  isPanning = false;
  pinch = false;
}, {passive:true});

/* Swipe left/right to next/prev ‚Äî only when not zoomed */
let swipeStartX = 0, swipeStartY = 0, swiping = false;

el.viewer.addEventListener("touchstart", (e)=>{
  if(!el.viewer.classList.contains("open")) return;
  if(e.touches.length !== 1) return;
  if(scale > 1) return; // zoomed => pan only
  const t = e.touches[0];
  swipeStartX = t.clientX; swipeStartY = t.clientY;
  swiping = true;
}, {passive:true});

el.viewer.addEventListener("touchend", (e)=>{
  if(!swiping) return;
  swiping = false;
  const t = e.changedTouches[0];
  const dx = t.clientX - swipeStartX;
  const dy = t.clientY - swipeStartY;
  if(Math.abs(dx) > 55 && Math.abs(dx) > Math.abs(dy)){
    if(dx < 0) nextPhoto();
    else prevPhoto();
  }
}, {passive:true});

/* Keyboard */
window.addEventListener("keydown", (e)=>{
  if(!el.viewer.classList.contains("open")) return;
  if(e.key === "Escape") closeViewer();
  if(e.key === "ArrowRight") nextPhoto();
  if(e.key === "ArrowLeft") prevPhoto();
});

/* Utils */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* Boot */
(async function init(){
  try{
    if(!API_KEY || API_KEY.includes("PASTE_")){
      el.status.textContent = "‚ö†Ô∏è API_KEY missing. Paste your API key.";
      return;
    }
    await loadFolders();
    setPage("home");
  }catch(err){
    console.error(err);
    el.status.textContent = "Error: " + err.message;
  }
})();
</script>
</body>
</html>